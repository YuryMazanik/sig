<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Своя Игра - Многопользовательская с сохранением состояния</title>
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
	<style>
		:root {
    --primary: #0b0f1a;
    --secondary: #1c2233;
    --accent: #ffcc00;
    --accent-hover: #ffe066;
    --used: #3a3f55;
    --text-light: #f8f8f8;
    --text-dark: #1a1a1a;
    --border-radius: 10px;
    --transition: 0.3s ease;
    --glow: 0 0 10px rgba(255, 204, 0, 0.6);
}

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at top left, #0b0f1a, #121826);
    color: var(--text-light);
}

.container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
}

.board {
    display: flex;
    border-radius: var(--border-radius);
    flex-direction: column;
	margin: 10px;
}
.row {
	display: inline-flex;
}
.cell {
    background: var(--accent);
    color: var(--text-dark);
    font-weight: bold;
    font-size: 22px;
    text-align: center;
	align-content: center;
    padding: 15px;
    margin: 2px;    
	width: 50px;
    height: 50px;
    border-radius: var(--border-radius);
    box-shadow: var(--glow);
}

.cell:not(.header) {
    cursor: pointer;
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
}

.cell:hover:not(.header) {
    background: var(--accent-hover);
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 255, 150, 0.8);
}

.cell.used {
    background: var(--used);
    color: #aaa;
    cursor: default;
    box-shadow: none;
}

.cell.header {
    background: white;
	width: 260px;
}

.leaderboard {
    background: var(--secondary);
    padding: 24px;
    border-radius: var(--border-radius);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
    margin: 10px;
    min-width: 200px;
	max-width: 300px;
}

.leaderboard h1,
.leaderboard h2 {
    margin: 0 0 12px;
    color: var(--accent);
    text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
}

.leaderboard .leaderboard__btn {
	display: flex;
    flex-wrap: nowrap;
    flex-direction: column;
}

.player {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #2b324a;
    border-radius: var(--border-radius);
    margin-bottom: 10px;
}

button {
    background: var(--accent);
    color: var(--text-dark);
    border: none;
    padding: 12px 24px;
	margin: 3px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: bold;
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
    box-shadow: var(--glow);
}

button:hover {
    background: var(--accent-hover);
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 255, 150, 0.8);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(10, 10, 20, 0.85);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
}

.modal.open {
    display: flex;
}

.modal-content {
    background: var(--secondary);
    padding: 30px;
    border-radius: var(--border-radius);
    width: 100%;
    max-width: 70vw;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}

/* Мобильная адаптация */
@media (max-width: 768px) {
	
	.board {
		display: block;
		overflow-x: auto;
	}
	.leaderboard {
		max-width: none;
		width: 100%;
	}

    .modal-content {
        width: 100%;
        height: 100%;
        max-width: none;
        max-height: none;
        border-radius: 0;
        padding: 20px;
    }
    .close {
        font-size: 56px;
        top: 15px;
        right: 20px;
    }
}

.close {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 48px; /* Было 28px */
    cursor: pointer;
    color: var(--accent);
    line-height: 1;
    transition: transform 0.2s ease;
}

.close:hover {
    transform: scale(1.2);
}

.questionText {
    font-size: 20px;
    margin: 20px 0;
}

.correctAnswer {
    color: #00ff99;
    font-size: 22px;
    font-weight: bold;
	display:none; 
	font-weight:bold; 
	margin:10px 0;
}

#modalControls {
    margin-top: 20px;
}

#modalControls button {
    margin-top: 10px;
}

.player-controls {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}
.player-controls span {
    font-size: 26px;
}
.player-controls div button {
    margin-left: 10px;
}

	</style>
</head>

<body>
	<div class="container">
		<!-- Игровое поле -->
		<div class="board" id="gameBoard">
			<!-- Категории и ячейки с вопросами создаются динамически -->
		</div>
		<!-- Таблица лидеров -->
		<div class="leaderboard" id="leaderboard">
			<h1 class="roundText"></h1>
			<h2>Таблица лидеров</h2>
			<div id="playersList">
				<!-- Список игроков -->
			</div>
			<div class="leaderboard__btn">
				<button onclick="addPlayer()">Добавить игрока</button>
				<button onclick="nextRound()">Следующий раунд</button>
				<button class="btn-reset" onclick="resetGame()">Сбросить игру</button>
			</div>
		</div>
	</div>

	<!-- Модальное окно для вопроса -->
	<div id="questionModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeModal()">&times;</span>
			<h2 id="questionTitle">Вопрос</h2>
			<p class="questionText">Текст вопроса</p>
			<button id="showAnswerBtn" onclick="showAnswer()">Показать ответ</button>
			<p class="correctAnswer"></p>
			<div id="modalControls">
				<!-- Панель начисления очков для игроков -->
			</div>
		</div>
	</div>

	<script>
		const roundQuestion = [
			[
				{
					title: "История",
					questions: [
						{ value: 100, question: "Кто был первым князем Древней Руси?", answer: "Рюрик" },
						{ value: 200, question: "В каком году произошла Октябрьская революция?", answer: "1917" },
						{ value: 300, question: "Кто такой Ленин?", answer: "Революционер" },
						{ value: 400, question: "Кто возглавлял СССР во время Второй мировой войны?", answer: "Сталин" },
						{ value: 500, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "История2",
					questions: [
						{ value: 100, question: "Кто был первым князем Древней Руси?", answer: "Рюрик" },
						{ value: 200, question: "В каком году произошла Октябрьская революция?", answer: "1917" },
						{ value: 300, question: "Кто такой Ленин?", answer: "Революционер" },
						{ value: 400, question: "Кто возглавлял СССР во время Второй мировой войны?", answer: "Сталин" },
						{ value: 500, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "История3",
					questions: [
						{ value: 100, question: "Кто был первым князем Древней Руси?", answer: "Рюрик" },
						{ value: 200, question: "В каком году произошла Октябрьская революция?", answer: "1917" },
						{ value: 300, question: "Кто такой Ленин?", answer: "Революционер" },
						{ value: 400, question: "Кто возглавлял СССР во время Второй мировой войны?", answer: "Сталин" },
						{ value: 500, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "Литературное вымя",
					questions: [
						{ value: 100, question: "Кто написал 'Война и мир'?", answer: "Толстой" },
						{ value: 200, question: "Автор 'Преступления и наказания'?", answer: "Достоевский" },
						{ value: 300, question: "Кто автор поэмы 'Руслан и Людмила'?", answer: "Пушкин" },
						{ value: 400, question: "Кто придумал Шерлока Холмса?", answer: "Конан Дойл" },
						{ value: 500, question: "Кто написал 'Мастер и Маргарита'?", answer: "Булгаков" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "Спорт",
					questions: [
						{ value: 100, question: "Сколько игроков в футбольной команде?", answer: "11" },
						{ value: 200, question: "Как называется чемпионат мира по футболу?", answer: "Чемпионат мира" },
						{ value: 300, question: "В каком виде спорта используется клюшка и шайба?В каком виде спорта используется клюшка и шайба?", answer: "Хоккей" },
						{ value: 400, question: "Кто выиграл чемпионат мира 2018 по футболу?", answer: "Франция" },
						{ value: 500, question: "Кто является рекордсменом по золотым медалям на Олимпийских играх?", answer: "Майкл Фелпс" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "География",
					questions: [
						{ value: 100, question: "Какая самая большая страна по территории?", answer: "Россия" },
						{ value: 200, question: "Столица Франции?", answer: "Париж" },
						{ value: 300, question: "Самая длинная река в мире?", answer: "Нил" },
						{ value: 400, question: "Какой океан самый большой?", answer: "Тихий океан" },
						{ value: 500, question: "Какая страна имеет самую большую численность населения?", answer: "Китай" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "Кино",
					questions: [
						{ value: 100, question: "Кто режиссёр 'Титаника'?", answer: "Кэмерон" },
						{ value: 200, question: "Какой фильм получил Оскар в 2020 году?", answer: "Паразиты" },
						{ value: 300, question: "Кто сыграл Джеймса Бонда в 'Казино Рояль'?", answer: "Дэниел Крейг" },
						{ value: 400, question: "Кто снял 'Темного рыцаря'?", answer: "Кристофер Нолан" },
						{ value: 500, question: "Какой фильм считается классикой по версии киноакадемии?", answer: "Крестный отец" },
						{ value: 600, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				}
			],
			[
				{
					title: "История",
					questions: [
						{ value: 100, question: "Кто был первым князем Древней Руси?", answer: "Рюрик" },
						{ value: 200, question: "В каком году произошла Октябрьская революция?", answer: "1917" },
						{ value: 300, question: "Кто такой Ленин?", answer: "Революционер" },
						{ value: 400, question: "Кто возглавлял СССР во время Второй мировой войны?", answer: "Сталин" },
						{ value: 500, question: "Какой договор завершил Первую мировую войну?", answer: "Версальский договор" }
					]
				},
				{
					title: "Наука",
					questions: [
						{ value: 100, question: "Какое тело вращается вокруг Земли?", answer: "Луна" },
						{ value: 200, question: "Кто открыл закон всемирного тяготения?", answer: "Ньютон" },
						{ value: 300, question: "Что изучает космология?", answer: "Структуру вселенной" },
						{ value: 400, question: "Как называется частица, обнаруженная в 2012 году в ЦЕРН?", answer: "Бозон Хиггса" },
						{ value: 500, question: "Что такое молекула?", answer: "Соединение атомов" },
					]
				}
			]
		];

		let currentRound = localStorage.getItem("currentRound") || 0;

		if (!roundQuestion[currentRound]) {
			currentRound = 0;
		}

		document.querySelector('.roundText').innerHTML = 'Round ' + (Number(currentRound) + 1);

		const categories = roundQuestion[currentRound];
		const modalControls = document.getElementById("modalControls");

		/* Загрузка сохранённых данных */
		let players = JSON.parse(localStorage.getItem("players")) || [];
		let usedQuestions = JSON.parse(localStorage.getItem("usedQuestions")) || {};

		let currentQuestion = null;
		let currentCategoryIndex = null;
		let currentQuestionIndex = null;
		let finishQuestion = false; // Для отслеживания начисления очков за вопрос

		/* Функции сохранения состояния */
		function savePlayers() {
			localStorage.setItem("players", JSON.stringify(players));
		}

		function saveUsedQuestions() {
			localStorage.setItem("usedQuestions", JSON.stringify(usedQuestions));
		}

		/* Инициализация игрового поля */
		function initBoard() {
			const board = document.getElementById("gameBoard");
			const countColumn = categories.length;
			board.innerHTML = "";
			categories.forEach((cat, catIndex) => {
				
				const row = document.createElement('div');
				row.className = 'row';

				const headerCell = document.createElement('div');
				headerCell.className = 'cell header';
				headerCell.textContent = cat.title;
				row.appendChild(headerCell);

				cat.questions.forEach((q, qIndex) => {
					const qId = currentRound + "-" + catIndex + "-" + qIndex;
					const cell = document.createElement('div');
					cell.className = 'cell';
					cell.textContent = q.value;

					if (usedQuestions[qId]) {
						cell.classList.add("used");
						cell.onclick = function () { openQuestion(catIndex, qIndex, cell); };
					} else {
						cell.onclick = function () { openQuestion(catIndex, qIndex, cell); };
					}

					row.appendChild(cell);
				});
				board.appendChild(row);
			});
		}

		/* Открытие модального окна с вопросом */
		function openQuestion(catIndex, qIndex, cellElem) {
			currentCategoryIndex = catIndex;
			currentQuestionIndex = qIndex;
			currentQuestion = categories[catIndex].questions[qIndex];


			// Скрываем ранее показанный ответ
			const correctAnswerEl = document.querySelector(".correctAnswer");
			correctAnswerEl.style.display = "none";
			correctAnswerEl.textContent = "";
			document.getElementById("showAnswerBtn").disabled = false;

			document.getElementById("questionTitle").textContent = categories[catIndex].title + " " + currentQuestion.value + " очков";
			document.querySelector(".questionText").textContent = currentQuestion.question;

			const qId = `${currentRound}-${catIndex}-${qIndex}`;
			renderPlayerControls(qId);
			saveUsedQuestions();
		
			cellElem.classList.add("used");

			// Открываем модальное окно
			document.getElementById("questionModal").classList.add('open');
		}

		/* Обновление панели управления в модальном окне */
		function renderPlayerControls(qId) {
			let isUsed = false;
			modalControls.innerHTML = "";

			if(typeof usedQuestions[qId] === 'undefined') {
				usedQuestions[qId] = {};
			} else {
				isUsed = true;
			}

			players.forEach((player, index) => {
				const container = document.createElement("div");
				container.classList.add('player-controls');

				const spanName = document.createElement("span");
				spanName.textContent = player.name;
				container.appendChild(spanName);

				const spanScore = document.createElement("span");
				spanScore.style.margin = "0 10px";
				spanScore.textContent = player.score;
				container.appendChild(spanScore);

				const btnContainer = document.createElement("div");
				const btnCorrect = document.createElement("button");
				btnCorrect.textContent = "Правильно";
				btnCorrect.style.marginLeft = "10px";
				btnCorrect.onclick = function () {
					if (typeof usedQuestions[qId][player.id] === 'undefined') {
						updateScore(player.id, currentQuestion.value);

						spanScore.textContent = Number(spanScore.textContent) + Number(currentQuestion.value); //добавление очков визуально
						spanScore.style.color = "green";
						
						usedQuestions[qId][player.id] = true;
						saveUsedQuestions();
						btnCorrect.disabled = true;
						btnWrong.disabled = true;
						btnCorrect.style.opacity = 0.5;
						btnWrong.style.opacity = 0.1;
					}
				};

				const btnWrong = document.createElement("button");
				btnWrong.textContent = "Неправильно";
				btnWrong.style.marginLeft = "10px";
				btnWrong.onclick = function () {
					if (typeof usedQuestions[qId][player.id] === 'undefined') {
						updateScore(player.id, -currentQuestion.value);

						spanScore.textContent = Number(spanScore.textContent) - Number(currentQuestion.value); //отнимает очки визуально
						spanScore.style.color = "red";

						usedQuestions[qId][player.id] = false;
						saveUsedQuestions();
						btnCorrect.disabled = true;
						btnWrong.disabled = true;
						btnCorrect.style.opacity = 0.1;
						btnWrong.style.opacity = 0.5;
					}
				};

				if (isUsed) {
					spanScore.remove();
					btnCorrect.disabled = true;
					btnWrong.disabled = true;
					if(typeof usedQuestions[qId][player.id] === 'undefined') {
						btnCorrect.style.opacity = 0.1;
						btnWrong.style.opacity = 0.1;
					} else if(usedQuestions[qId][player.id]) {
						btnCorrect.style.opacity = 0.5;
						btnWrong.style.opacity = 0.1;
					} else {
						btnCorrect.style.opacity = 0.1;
						btnWrong.style.opacity = 0.5;
					}
				}

				btnContainer.appendChild(btnCorrect);
				btnContainer.appendChild(btnWrong);

				container.appendChild(btnContainer);
				modalControls.appendChild(container);
			});

			// Кнопка закрытия вопроса
			const closeBtn = document.createElement("button");
			closeBtn.textContent = "Закрыть вопрос";
			closeBtn.style.marginTop = "20px";
			closeBtn.style.padding = "10px 20px";
			closeBtn.onclick = function () { closeModal(); };
			modalControls.appendChild(closeBtn);
		}

		/* Показ правильного ответа */
		function showAnswer() {
			const correctAnswerEl = document.querySelector(".correctAnswer");
			correctAnswerEl.textContent = "Ответ: " + currentQuestion.answer;
			correctAnswerEl.style.display = "block";
			document.getElementById("showAnswerBtn").disabled = true;
		}

		/* Закрытие модального окна */
		function closeModal() {
			document.getElementById("questionModal").classList.remove('open');
		}

		/* Добавление игрока */
		function addPlayer() {
			let name = prompt("Введите имя игрока:");
			if (name) {
				players.push({id: players.length+1,name: name, score: 0 });
				savePlayers();
				renderLeaderboard();
			}
		}

		/* Обновление счёта игрока */
		function updateScore(playerId, points, fullUpdate) {
			const playerIndex = players.findIndex(item => item.id === playerId);
			if(fullUpdate) {
				players[playerIndex].score = Number(points);
			} else {
				players[playerIndex].score += Number(points);
			}
			savePlayers();
			renderLeaderboard();
		}

		/* Сброс очков */
		function resetGame() {

			let reset = confirm("Сбросить игру?");
			if (reset) {
				localStorage.clear();
				window.location.reload();
			}
		}

		/* Следующий раунд */
		function nextRound() {
			localStorage.setItem("currentRound", (roundQuestion.length <= currentRound) ? 0 : Number(currentRound) + 1);
			window.location.reload();
		}

		/* Отрисовка таблицы лидеров */
		function renderLeaderboard() {
			const list = document.getElementById("playersList");
			list.innerHTML = "";
			// Сортировка по очкам (по убыванию)
			let sortPlayers = players.toSorted((a, b) => b.score - a.score);
			sortPlayers.forEach((player, index) => {
				const div = document.createElement("div");
				div.className = "player";
				
				const scoreSpan = document.createElement("span");
				scoreSpan.textContent = player.score;
				scoreSpan.style.cursor = "pointer";
				scoreSpan.onclick = function() { showEditField(player, scoreSpan); };

				div.innerHTML = `<span>${player.name}</span>`;
				div.appendChild(scoreSpan);
				list.appendChild(div);
			});
		}

		function showEditField(player, scoreSpan) {
			const input = document.createElement("input");
			input.type = "number";
			input.value = player.score;
			input.style.width = "90px";
			input.onblur = function() { updateScore(player.id, input.value, true); };
			input.onkeydown = function(event) {
				if (event.key === "Enter") {
					updateScore(player.id, input.value, true);
				}
			};

			scoreSpan.replaceWith(input);
			input.focus();
		}

		// Инициализация при загрузке
		window.onload = function () {
			initBoard();
			renderLeaderboard();
		}
	</script>
</body>

</html>
